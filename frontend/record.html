<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SenseLense â€” Record Session</title>
    <meta name="description"
        content="Capture live conversation with Presage emotion tracking and Wispr transcription." />
    <link rel="stylesheet" href="css/styles.css" />
    <script>
        /* Apply saved theme + accent color immediately */
        (function () {
            var t = localStorage.getItem('sl-theme');
            if (t === 'light') document.documentElement.setAttribute('data-theme', 'light');
            var accent = localStorage.getItem('sl-accent');
            if (accent) {
                var r = parseInt(accent.slice(1, 3), 16), g = parseInt(accent.slice(3, 5), 16), b = parseInt(accent.slice(5, 7), 16);
                var root = document.documentElement;
                root.style.setProperty('--red', accent);
                root.style.setProperty('--red-light', 'rgb(' + Math.min(255, r + 30) + ',' + Math.min(255, g + 30) + ',' + Math.min(255, b + 30) + ')');
                root.style.setProperty('--red-dark', 'rgb(' + Math.floor(r * .72) + ',' + Math.floor(g * .72) + ',' + Math.floor(b * .72) + ')');
                root.style.setProperty('--red-glow', 'rgba(' + r + ',' + g + ',' + b + ',.25)');
                root.style.setProperty('--border-red', 'rgba(' + r + ',' + g + ',' + b + ',.4)');
            }
        })();
    </script>
    <style>
        /* â”€â”€ Record-page extras â”€â”€ */
        .rec-page {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 24px;
            align-items: start;
        }

        .camera-feed {
            background: #000;
            border-radius: var(--radius-lg);
            overflow: hidden;
            aspect-ratio: 16/9;
            position: relative;
            border: 1px solid var(--border);
        }

        .camera-feed video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .camera-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 12px;
            color: var(--text-muted);
            background: var(--surface-1);
        }

        .camera-overlay svg {
            width: 48px;
            height: 48px;
            opacity: 0.3;
        }

        .camera-badge {
            position: absolute;
            top: 14px;
            left: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            border-radius: 99px;
            padding: 6px 12px;
            font-size: 12px;
            font-weight: 700;
            color: #fff;
        }

        .camera-badge .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--negative);
            animation: pulse-dot 1s infinite;
        }

        .emotion-chip-row {
            position: absolute;
            bottom: 14px;
            left: 14px;
            right: 14px;
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .live-chip {
            padding: 4px 12px;
            border-radius: 99px;
            font-size: 11px;
            font-weight: 700;
            backdrop-filter: blur(8px);
            background: rgba(0, 0, 0, 0.65);
            border: 1px solid rgba(255, 255, 255, 0.08);
            color: var(--text-secondary);
            transition: all 0.3s ease;
        }

        .live-chip.active {
            background: rgba(204, 0, 0, 0.3);
            border-color: var(--red);
            color: #fff;
        }

        .transcript-feed {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 280px;
            overflow-y: auto;
            padding-right: 4px;
        }

        .transcript-line {
            display: flex;
            gap: 10px;
            animation: fade-in-up 0.3s ease;
        }

        @keyframes fade-in-up {
            from {
                opacity: 0;
                transform: translateY(8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .transcript-line__speaker {
            font-size: 10px;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            white-space: nowrap;
            padding-top: 2px;
            min-width: 40px;
        }

        .transcript-line__text {
            font-size: 13px;
            color: var(--text-primary);
            line-height: 1.5;
        }

        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        @media (max-width: 900px) {
            .rec-page {
                grid-template-columns: 1fr;
            }
        }

        /* â”€â”€ MorphCast Emotion Analytics Panel â”€â”€ */
        .mc-metric-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .mc-metric {
            background: var(--surface-3);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 12px 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            text-align: center;
        }

        .mc-metric__label {
            font-size: 9px;
            font-weight: 700;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            color: var(--text-muted);
        }

        .mc-metric__value {
            font-size: 22px;
            font-weight: 800;
            line-height: 1;
            color: var(--text-primary);
            transition: color 0.4s ease;
        }

        .mc-metric__sub {
            font-size: 10px;
            color: var(--text-muted);
        }

        /* Attention SVG ring */
        .mc-ring-wrap {
            position: relative;
            width: 64px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mc-ring-svg {
            transform: rotate(-90deg);
        }

        .mc-ring-inner {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1px;
        }

        .mc-ring-num {
            font-size: 14px;
            font-weight: 800;
            color: var(--red);
            line-height: 1;
        }

        .mc-ring-pct {
            font-size: 8px;
            color: var(--text-muted);
        }

        /* Valence track */
        .mc-val-track {
            width: 100%;
            height: 5px;
            background: var(--surface-4);
            border-radius: 99px;
            overflow: hidden;
            margin-top: 4px;
        }

        .mc-val-fill {
            height: 100%;
            border-radius: 99px;
            transition: width 0.4s ease, background 0.4s ease;
        }

        /* Emotion bars */
        .mc-bars {
            display: flex;
            flex-direction: column;
            gap: 7px;
        }

        .mc-bar-item {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .mc-bar-row {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: var(--text-muted);
        }

        .mc-bar-row span:last-child {
            color: var(--text-secondary);
            font-weight: 600;
        }

        .mc-bar-track {
            height: 5px;
            background: var(--surface-4);
            border-radius: 99px;
            overflow: hidden;
        }

        .mc-bar-fill {
            height: 100%;
            border-radius: 99px;
            transition: width 0.35s ease;
            width: 0%;
        }

        /* Low-attention alarm */
        .mc-alarm {
            display: none;
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.35);
            color: var(--negative);
            font-size: 11px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 12px;
            animation: mc-flash 1.2s infinite;
        }

        .mc-alarm.show {
            display: block;
        }

        @keyframes mc-flash {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }
    </style>
    <script src="js/auth.js"></script>
    <script src="js/api.js"></script>
    <script src="js/utils.js"></script>
    <!-- MorphCast AI SDK -->
    <script src="https://ai-sdk.morphcast.com/v1.16/ai-sdk.js"></script>
</head>

<body>
    <div class="app-shell">

        <aside class="sidebar">
            <div class="sidebar__logo">
                <svg id="adp-logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 60"
                    style="height:36px;width:auto;color:var(--red);transition:color .2s ease">
                    <path
                        d="M81.952 21.15H78.08v3.87h3.873a1.66 1.66 0 0 1 1.659 1.663c0 .92-.74 1.66-1.66 1.66H78.08v3.872h3.873c3.056 0 5.532-2.478 5.532-5.532s-2.476-5.532-5.532-5.532zM59.88 41.624c4.636 0 8.632-2.715 10.5-6.645h4.937v6.645h2.764V34.98h3.873a8.3 8.3 0 0 0 8.301-8.297 8.3 8.3 0 0 0-8.301-8.299h-6.637v9.96h-3.94a11.62 11.62 0 0 0-11.497-9.959H46.26L32.7 41.624h3.232l3.872-6.645h13.923v6.645zm34.247-14.942c0 6.72-5.45 12.17-12.174 12.17V45.5h-10.5v-5.2c-2.843 3.2-6.966 5.2-11.563 5.2H49.865v-6.638h-7.827L38.166 45.5H25.873l18.07-30.98H59.88c4.598 0 8.72 2.006 11.564 5.184V14.5h10.5a12.18 12.18 0 0 1 12.174 12.172zM49.865 21.15v7.2h-6.178l-2.256 3.872h12.307V21.15zM68.734 30c0 4.9-3.966 8.85-8.854 8.85h-3.376v-3.87h3.376A4.98 4.98 0 0 0 64.862 30c0-2.747-2.23-4.98-4.982-4.98h-3.376v-3.87h3.376c4.888 0 8.854 3.962 8.854 8.85"
                        fill="currentColor" />
                </svg>
                <div class="sidebar__tagline">SenseLense</div>
            </div>
            <nav class="sidebar__nav">
                <div class="nav-section-label">Main</div>
                <a class="nav-item" href="index.html">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="7" height="7" />
                        <rect x="14" y="3" width="7" height="7" />
                        <rect x="14" y="14" width="7" height="7" />
                        <rect x="3" y="14" width="7" height="7" />
                    </svg>
                    Dashboard
                </a>
                <a class="nav-item" href="clients.html">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                        <circle cx="9" cy="7" r="4" />
                    </svg>
                    Clients
                </a>
                <a class="nav-item" href="sessions.html">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10" />
                        <polyline points="12 6 12 12 16 14" />
                    </svg>
                    Sessions
                </a>
                <div class="nav-section-label">Actions</div>
                <a class="nav-item active" href="record.html">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10" />
                        <circle cx="12" cy="12" r="3" fill="currentColor" />
                    </svg>
                    New Session
                </a>


                <a class="nav-item" href="#" id="nav-tutorial" onclick="event.preventDefault();SLTutorial.open()">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" />
                        <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 0 3-3h7z" />
                    </svg>
                    Tutorial
                </a>

                <div class="nav-section-label">System</div>
                <a class="nav-item" href="settings.html" id="nav-settings">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="3" />
                        <path
                            d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z" />
                    </svg>
                    Settings
                </a>
            </nav>
            <div class="sidebar__footer">
                <button class="theme-toggle" id="theme-btn" onclick="toggleTheme()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5" />
                        <line x1="12" y1="1" x2="12" y2="3" />
                        <line x1="12" y1="21" x2="12" y2="23" />
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" />
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" />
                        <line x1="1" y1="12" x2="3" y2="12" />
                        <line x1="21" y1="12" x2="23" y2="12" />
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" />
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" />
                    </svg>
                    <span id="theme-label">Light Mode</span>
                    <div class="toggle-track">
                        <div class="toggle-thumb"></div>
                    </div>
                </button>
                <div class="status-badge" style="margin-top:10px">
                    <div class="status-dot" id="api-dot"></div>
                    <span id="api-text">Connectingâ€¦</span>
                </div>
            </div>
        </aside>

        <div class="main">
            <header class="topbar">
                <div>
                    <div class="topbar__title">New Session</div>
                    <div class="topbar__sub" id="session-label">Configure below to begin</div>
                </div>
                <div class="topbar__actions">
                    <div class="rec-timer" id="timer"
                        style="font-size:20px;font-variant-numeric:tabular-nums;font-weight:800;color:var(--text-muted)">
                        00:00</div>
                    <button class="btn btn-primary btn-lg" id="rec-btn" style="min-width:150px">
                        <svg width="14" height="14" id="rec-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10" />
                            <circle cx="12" cy="12" r="3" fill="currentColor" stroke="none" />
                        </svg>
                        <span id="rec-btn-text">Start Recording</span>
                    </button>
                </div>
            </header>

            <main class="page-content">

                <!-- Setup Row (hidden once recording starts) -->
                <div id="setup-row" style="margin-bottom:24px">
                    <div class="card">
                        <div class="card__title" style="margin-bottom:16px">Session Setup</div>
                        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px">
                            <div class="form-group" style="margin:0">
                                <label class="form-label" for="sel-client">Client *</label>
                                <select class="form-input" id="sel-client">
                                    <option value="">Select clientâ€¦</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin:0">
                                <label class="form-label" for="sel-title">Session Title</label>
                                <input class="form-input" type="text" id="sel-title"
                                    placeholder="e.g. Discovery Call" />
                            </div>
                            <div style="display:flex;align-items:flex-end">
                                <a href="clients.html" class="btn btn-outline"
                                    style="width:100%;justify-content:center">+ New Client</a>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="rec-page">

                    <!-- LEFT: Camera + Transcript -->
                    <div style="display:flex;flex-direction:column;gap:20px">

                        <!-- Camera -->
                        <div class="camera-feed" id="camera-wrap">
                            <div class="camera-overlay" id="camera-overlay">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M23 7l-7 5 7 5V7z" />
                                    <rect x="1" y="5" width="15" height="14" rx="2" ry="2" />
                                </svg>
                                <span style="font-size:13px">Camera will appear when recording starts</span>
                            </div>
                            <video id="camera-video" autoplay muted playsinline style="display:none"></video>

                            <div class="camera-badge" id="rec-badge" style="display:none">
                                <div class="dot"></div>
                                LIVE Â· <span id="badge-timer">00:00</span>
                            </div>

                            <div class="emotion-chip-row" id="emotion-chips" style="display:none">
                                <span class="live-chip" id="chip-neutral">Neutral</span>
                                <span class="live-chip" id="chip-happy">Happy ðŸ˜Š</span>
                                <span class="live-chip" id="chip-confused">Confused ðŸ¤”</span>
                                <span class="live-chip" id="chip-engaged">Engaged âœ¨</span>
                                <span class="live-chip" id="chip-negative">Displeased ðŸ˜Ÿ</span>
                            </div>
                        </div>

                        <!-- Transcript Feed -->
                        <div class="card" style="padding:0;overflow:hidden">
                            <div
                                style="padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between">
                                <div class="card__title" style="margin:0">Live Transcript</div>
                                <span class="badge blue" id="transcript-source">Wispr / ElevenLabs</span>
                            </div>
                            <div class="transcript-feed" style="padding:16px 20px;min-height:160px"
                                id="transcript-wrap">
                                <div style="color:var(--text-muted);font-size:13px;text-align:center;padding:40px 0">
                                    Transcript will appear here during recordingâ€¦
                                </div>
                            </div>
                        </div>

                    </div>

                    <!-- RIGHT Panel -->
                    <div class="right-panel">

                        <!-- Controls -->
                        <div class="rec-panel" id="rec-panel">
                            <div class="rec-ring" id="rec-ring">
                                <svg class="rec-icon" id="rec-ring-icon" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                                    stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10" />
                                    <circle cx="12" cy="12" r="4" fill="currentColor" stroke="none" />
                                </svg>
                            </div>
                            <div id="rec-status-text" style="font-size:15px;font-weight:600;color:var(--text-muted)">
                                Ready to Record</div>
                            <div style="font-size:12px;color:var(--text-muted);max-width:220px;text-align:center">
                                Select a client above, then press Start Recording. Presage + Wispr will capture the
                                session automatically.
                            </div>
                        </div>

                        <!-- MorphCast Live Emotion Analytics -->
                        <div class="card" id="morphcast-panel" style="display:none">
                            <div class="card__title" style="margin-bottom:12px">Live Emotion Analytics
                                <span
                                    style="font-size:10px;font-weight:500;color:var(--text-muted);margin-left:8px">MorphCast</span>
                            </div>

                            <div class="mc-alarm" id="mc-alarm">âš  LOW ATTENTION DETECTED</div>

                            <!-- 3 metrics: attention Â· emotion Â· mood -->
                            <div class="mc-metric-row">
                                <div class="mc-metric">
                                    <div class="mc-metric__label">Attention</div>
                                    <div class="mc-ring-wrap">
                                        <svg class="mc-ring-svg" width="64" height="64" viewBox="0 0 64 64">
                                            <circle cx="32" cy="32" r="26" fill="none" stroke="var(--surface-4)"
                                                stroke-width="6" />
                                            <circle cx="32" cy="32" r="26" fill="none" stroke="var(--red)"
                                                stroke-width="6" stroke-dasharray="163.4" stroke-dashoffset="163.4"
                                                id="mc-ring-circle" stroke-linecap="round"
                                                style="transition:stroke-dashoffset 0.7s ease;" />
                                        </svg>
                                        <div class="mc-ring-inner">
                                            <div class="mc-ring-num" id="mc-att-val">â€”</div>
                                            <div class="mc-ring-pct">%</div>
                                        </div>
                                    </div>
                                    <div class="mc-metric__sub" id="mc-att-raw">raw: â€”</div>
                                </div>

                                <div class="mc-metric">
                                    <div class="mc-metric__label">Dominant</div>
                                    <div class="mc-metric__value" id="mc-dom-emo"
                                        style="font-size:16px;color:var(--positive)">â€”</div>
                                    <div class="mc-metric__sub" id="mc-positivity">Pos: â€”</div>
                                </div>

                                <div class="mc-metric">
                                    <div class="mc-metric__label">Mood</div>
                                    <div class="mc-metric__value" id="mc-valence-val">â€”</div>
                                    <div class="mc-val-track">
                                        <div class="mc-val-fill" id="mc-val-bar" style="background:var(--neutral)">
                                        </div>
                                    </div>
                                    <div class="mc-metric__sub" id="mc-val-desc">â€”</div>
                                </div>
                            </div>

                            <!-- 5-emotion bars -->
                            <div class="mc-bars" id="mc-emotion-bars">
                                <!-- populated by buildMcBars() -->
                            </div>
                        </div>

                        <!-- Live Emotion Breakdown (DeepFace) -->
                        <div class="card">
                            <div class="card__title" style="margin-bottom:16px">Emotion Tracker</div>
                            <div id="emotion-tracker">
                                <div style="color:var(--text-muted);font-size:12px;text-align:center;padding:20px 0">
                                    Will populate during recording
                                </div>
                            </div>
                        </div>

                        <!-- Session notes -->
                        <div class="card">
                            <div class="card__title" style="margin-bottom:12px">Quick Notes</div>
                            <textarea class="form-input" id="quick-notes" rows="4"
                                placeholder="Jot down context during the callâ€¦"></textarea>
                        </div>

                    </div>
                </div>

            </main>
        </div>
    </div>

    <div id="toast-container"></div>

    <script>
        function toggleTheme() { var t = localStorage.getItem('sl-theme') || 'dark'; var n = t === 'dark' ? 'light' : 'dark'; localStorage.setItem('sl-theme', n); document.documentElement.setAttribute('data-theme', n === 'light' ? 'light' : ''); var l = document.getElementById('theme-label'); if (l) l.textContent = n === 'light' ? 'Dark Mode' : 'Light Mode'; }
    </script>
    <script>

        const api = window.api;
        const { toast, fmtTimer } = window.utils;

        // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let recording = false;
        let sessionId = null;
        let timerSecs = 0;
        let timerHandle = null;
        let videoStream = null;

        // â”€â”€ Check for passed client_id param â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const params = new URLSearchParams(location.search);
        const preClient = params.get("client_id");

        // â”€â”€ API health â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        (async () => {
            try {
                await api.health();
                document.getElementById("api-dot").className = "status-dot online";
                document.getElementById("api-text").textContent = "Backend online";
            } catch {
                document.getElementById("api-dot").className = "status-dot";
                document.getElementById("api-text").textContent = "Backend offline";
                toast("Backend offline â€” make sure Flask is running on :5050", "error");
            }
        })();

        // â”€â”€ Load Clients â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let clientsMap = {};
        (async () => {
            try {
                const clients = await api.getClients();
                const sel = document.getElementById("sel-client");
                clients.forEach(c => {
                    clientsMap[c.id] = c.name;
                    const opt = document.createElement("option");
                    opt.value = c.id;
                    opt.textContent = `${c.name}${c.company ? " â€” " + c.company : ""}`;
                    sel.appendChild(opt);
                });
                if (preClient) sel.value = preClient;
            } catch { }
        })();

        // â”€â”€ Timer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function startTimer() {
            timerSecs = 0;
            timerHandle = setInterval(() => {
                timerSecs++;
                const t = fmtTimer(timerSecs);
                document.getElementById("timer").textContent = t;
                document.getElementById("badge-timer").textContent = t;
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerHandle);
            document.getElementById("timer").style.color = "var(--text-muted)";
        }

        // â”€â”€ MorphCast config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const MC_LICENSE = "sk514a0ced0dca050a7951d6591224c8cc7a7fec72762f";
        const MC_SNAPSHOT_MS = 20000; // send to DB every 20s

        const MC_DISPLAY_EMOS = ['Happy', 'Surprise', 'Sad', 'Negative', 'Neutral'];
        const MC_RAW_EMOS = ['Happy', 'Surprise', 'Sad', 'Angry', 'Disgust', 'Fear', 'Neutral'];
        const MC_EMO_COLORS = {
            Happy: 'var(--positive)', Surprise: '#60A5FA',
            Sad: '#818CF8', Negative: 'var(--negative)', Neutral: 'var(--text-muted)'
        };

        // MorphCast state
        let mcAttSmoothed = 100;
        const MC_ATT_RISE = 0.25, MC_ATT_FALL = 0.04;
        let mcBuf = { emotions: {}, attention: [], valence: [], positivity: [] };
        MC_RAW_EMOS.forEach(e => mcBuf.emotions[e] = []);
        let mcSnapshotHandle = null;
        let mcSdkStarted = false;

        function buildMcBars() {
            const c = document.getElementById('mc-emotion-bars'); c.innerHTML = '';
            MC_DISPLAY_EMOS.forEach(n => {
                const d = document.createElement('div'); d.className = 'mc-bar-item';
                d.innerHTML = `<div class="mc-bar-row"><span>${n}</span><span id="mc-ev-${n}">0%</span></div>
                    <div class="mc-bar-track"><div class="mc-bar-fill" id="mc-eb-${n}" style="background:${MC_EMO_COLORS[n]}"></div></div>`;
                c.appendChild(d);
            });
        }

        function setMcBar(name, val) {
            const bar = document.getElementById('mc-eb-' + name);
            const txt = document.getElementById('mc-ev-' + name);
            if (bar) bar.style.width = (val * 100).toFixed(1) + '%';
            if (txt) txt.textContent = (val * 100).toFixed(0) + '%';
        }

        function avgArr(arr) { return arr.length ? arr.reduce((a, b) => a + b, 0) / arr.length : 0; }

        function flushMcSnapshot() {
            if (!sessionId) return;
            const emoAvgs = {};
            MC_RAW_EMOS.forEach(e => emoAvgs[e] = avgArr(mcBuf.emotions[e]));
            const negative = Math.min(1, (emoAvgs.Angry || 0) + (emoAvgs.Disgust || 0) + (emoAvgs.Fear || 0));
            emoAvgs.Negative = negative;

            let dominant = 'Neutral', maxV = 0;
            MC_DISPLAY_EMOS.forEach(e => { const v = emoAvgs[e] || 0; if (v > maxV) { maxV = v; dominant = e; } });

            const tsMs = timerSecs * 1000;
            const valenceNorm = (avgArr(mcBuf.valence) - 50) / 50; // convert 0-100 â†’ -1..1

            // Store as a presage-compatible event with extra data in the text field
            window.api.ingestEvents(sessionId, [{
                timestamp_ms: tsMs,
                source: 'morphcast',
                emotion: dominant.toLowerCase(),
                valence: parseFloat(valenceNorm.toFixed(3)),
                text: JSON.stringify({
                    attention: Math.round(avgArr(mcBuf.attention)),
                    valence100: Math.round(avgArr(mcBuf.valence)),
                    positivity: Math.round(avgArr(mcBuf.positivity)),
                    emotions: Object.fromEntries(
                        MC_DISPLAY_EMOS.map(e => [e.toLowerCase(), parseFloat((emoAvgs[e] || 0).toFixed(3))]
                        ))
                })
            }]).catch(() => { });

            // Reset buffers
            MC_RAW_EMOS.forEach(e => mcBuf.emotions[e] = []);
            ['attention', 'valence', 'positivity'].forEach(k => mcBuf[k] = []);
        }

        function startMorphCast(stream) {
            if (typeof CY === 'undefined') {
                console.warn('[MorphCast] SDK not loaded â€” skipping.');
                return;
            }
            if (mcSdkStarted) return;
            mcSdkStarted = true;

            CY.loader()
                .licenseKey(MC_LICENSE)
                .maxInputFrameSize(480)
                .powerSave(0)
                .addModule(CY.modules().FACE_EMOTION.name)
                .addModule(CY.modules().FACE_ATTENTION.name)
                .addModule(CY.modules().FACE_AROUSAL_VALENCE.name)
                .addModule(CY.modules().FACE_POSITIVITY.name)
                .addModule(CY.modules().ALARM_LOW_ATTENTION.name, { threshold: 0.3 })
                .load()
                .then(({ start }) => {
                    start();
                    setupMcListeners();
                    document.getElementById('morphcast-panel').style.display = 'block';
                    buildMcBars();
                    // Periodic DB persistence
                    mcSnapshotHandle = setInterval(flushMcSnapshot, MC_SNAPSHOT_MS);
                })
                .catch(err => console.error('[MorphCast] SDK error:', err));
        }

        function stopMorphCast() {
            clearInterval(mcSnapshotHandle);
            flushMcSnapshot(); // final snapshot
            mcSdkStarted = false;
            document.getElementById('morphcast-panel').style.display = 'none';
            // MorphCast SDK has no explicit stop; camera tracks are stopped by stopCamera()
        }

        function setupMcListeners() {
            window.addEventListener(CY.modules().FACE_EMOTION.eventName, evt => {
                const out = evt.detail.output; if (!out) return;
                const raw = out.emotion || {};
                MC_RAW_EMOS.forEach(n => mcBuf.emotions[n].push(raw[n] || 0));
                const neg = Math.min(1, (raw.Angry || 0) + (raw.Disgust || 0) + (raw.Fear || 0));
                setMcBar('Happy', raw.Happy || 0);
                setMcBar('Surprise', raw.Surprise || 0);
                setMcBar('Sad', raw.Sad || 0);
                setMcBar('Negative', neg);
                setMcBar('Neutral', raw.Neutral || 0);

                let label = out.dominantEmotion || 'Neutral';
                if (['Angry', 'Disgust', 'Fear'].includes(label)) label = 'Negative';
                const domEl = document.getElementById('mc-dom-emo');
                if (domEl) {
                    domEl.textContent = label;
                    domEl.style.color = MC_EMO_COLORS[label] || 'var(--text-primary)';
                }

                // Also feed the legacy emotion tracker / chips
                const legacyEmo = label.toLowerCase();
                Object.values(CHIP_IDS).forEach(id => document.getElementById(id)?.classList.remove('active'));
                document.getElementById(CHIP_IDS[legacyEmo] || 'chip-neutral')?.classList.add('active');
                if (legacyEmo in EMOTION_COUNTS) EMOTION_COUNTS[legacyEmo]++;
                renderEmotionTracker();
            });

            window.addEventListener(CY.modules().FACE_ATTENTION.eventName, evt => {
                const raw = evt.detail.output.attention; if (raw === undefined) return;
                const rawPct = raw * 100, diff = rawPct - mcAttSmoothed;
                mcAttSmoothed = Math.max(0, Math.min(100,
                    mcAttSmoothed + (diff > 0 ? MC_ATT_RISE : MC_ATT_FALL) * diff
                ));
                const display = Math.round(mcAttSmoothed);
                mcBuf.attention.push(display);

                const attEl = document.getElementById('mc-att-val');
                const ringEl = document.getElementById('mc-ring-circle');
                const rawEl = document.getElementById('mc-att-raw');
                if (attEl) attEl.textContent = display;
                if (ringEl) ringEl.setAttribute('stroke-dashoffset', 163.4 - (163.4 * mcAttSmoothed / 100));
                if (rawEl) rawEl.textContent = `raw: ${Math.round(rawPct)}%`;
            });

            window.addEventListener(CY.modules().FACE_AROUSAL_VALENCE.eventName, evt => {
                const o = evt.detail.output; if (o.valence === undefined) return;
                const v = Math.round((o.valence + 1) / 2 * 100);
                mcBuf.valence.push(v);

                const valEl = document.getElementById('mc-valence-val');
                const barEl = document.getElementById('mc-val-bar');
                const descEl = document.getElementById('mc-val-desc');
                const col = v > 60 ? 'var(--positive)' : v < 40 ? 'var(--negative)' : 'var(--neutral)';
                const desc = v > 70 ? 'Positive' : v > 55 ? 'Mildly +' : v < 30 ? 'Negative' : v < 45 ? 'Mildly âˆ’' : 'Neutral';
                if (valEl) { valEl.textContent = v; valEl.style.color = col; }
                if (barEl) { barEl.style.width = v + '%'; barEl.style.background = col; }
                if (descEl) { descEl.textContent = desc; }
            });

            window.addEventListener(CY.modules().FACE_POSITIVITY.eventName, evt => {
                const pos = evt.detail.output.positivity; if (pos === undefined) return;
                mcBuf.positivity.push(Math.round(pos * 100));
                const posEl = document.getElementById('mc-positivity');
                if (posEl) posEl.textContent = `Pos: ${Math.round(pos * 100)}%`;
            });

            window.addEventListener(CY.modules().ALARM_LOW_ATTENTION.eventName, evt => {
                const alarm = document.getElementById('mc-alarm');
                if (!alarm) return;
                if (evt.detail.output.isLowAttention) alarm.classList.add('show');
                else alarm.classList.remove('show');
            });
        }

        // â”€â”€ Camera + Mic (video for MorphCast, audio for ElevenLabs) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let micStream = null;
        let mediaRecorder = null;
        const frameCanvas = document.createElement('canvas');
        const frameCtx = frameCanvas.getContext('2d');

        async function startCamera() {
            try {
                // Request BOTH video and audio in one permission prompt
                videoStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                const vid = document.getElementById("camera-video");
                vid.srcObject = videoStream;
                vid.style.display = "block";
                document.getElementById("camera-overlay").style.display = "none";

                // MorphCast: SDK listens on the live camera stream in the browser
                startMorphCast(videoStream);

                // ElevenLabs: record mic in chunks and POST to Flask
                startMicRecording(videoStream);

            } catch (err) {
                toast("Camera/mic access denied â€” both are required for full analysis", "error");
                console.error(err);
            }
        }

        function stopCamera() {
            stopMorphCast();
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            videoStream?.getTracks().forEach(t => t.stop());
            const vid = document.getElementById("camera-video");
            vid.style.display = "none";
            document.getElementById("camera-overlay").style.display = "flex";
        }

        // â”€â”€ ElevenLabs: record mic in 30s chunks -> POST to /transcribe â”€â”€â”€â”€â”€â”€
        function startMicRecording(stream) {
            const audioOnly = new MediaStream(stream.getAudioTracks());
            const mimeType = MediaRecorder.isTypeSupported('audio/webm;codecs=opus')
                ? 'audio/webm;codecs=opus' : 'audio/webm';

            const createRecorder = () => {
                const recorder = new MediaRecorder(audioOnly, { mimeType });
                recorder.ondataavailable = async (e) => {
                    if (!e.data || e.data.size < 2000) return; // ignore tiny/invalid chunks

                    const offsetMs = timerSecs * 1000;
                    const fd = new FormData();
                    fd.append('audio', e.data, 'chunk.webm');

                    try {
                        const result = await window.api.transcribeChunk(sessionId, fd, offsetMs);
                        if (result.segments?.length) {
                            toast(`Transcribed ${result.segments.length} new line(s)`, 'info');
                            pollTranscript();
                        }
                    } catch (err) {
                        console.warn('[ElevenLabs] Chunk error:', err.message);
                    }
                };
                return recorder;
            };

            mediaRecorder = createRecorder();
            mediaRecorder.start();

            // Cycle the recorder every 10 seconds to generate a fresh valid file with headers
            const cycleInterval = setInterval(() => {
                if (!recording) {
                    clearInterval(cycleInterval);
                    return;
                }
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                    mediaRecorder = createRecorder();
                    mediaRecorder.start();
                }
            }, 10000);
        }

        // â”€â”€ Real Emotion Tracking â€” polls Presage events from Flask â”€â”€â”€â”€â”€â”€
        const CHIP_IDS = {
            neutral: "chip-neutral", happy: "chip-happy",
            confused: "chip-confused", engaged: "chip-engaged", negative: "chip-negative"
        };
        const EMOTION_COUNTS = { neutral: 0, happy: 0, confused: 0, engaged: 0, negative: 0 };
        const EMOTION_COLORS = {
            neutral: "var(--text-muted)", happy: "var(--positive)",
            confused: "var(--neutral)", engaged: "#60A5FA", negative: "var(--negative)"
        };

        let emotionHandle = null;
        let lastEmotionEventId = 0;

        function startEmotionPoll() {
            document.getElementById("emotion-chips").style.display = "flex";
            pollEmotions(); // immediate first poll
            emotionHandle = setInterval(pollEmotions, 2400);
        }

        async function pollEmotions() {
            if (!sessionId) return;
            try {
                const data = await window.api.getSession(sessionId, true);
                const presageEvents = (data.events || []).filter(e => e.source === "presage");
                if (!presageEvents.length) return;

                // Only process new events since last poll
                const newEvents = presageEvents.filter(e => e.id > lastEmotionEventId);
                if (!newEvents.length) return;
                lastEmotionEventId = Math.max(...presageEvents.map(e => e.id));

                const latest = newEvents[newEvents.length - 1];
                const emo = latest.emotion || "neutral";

                // Update chip highlight
                Object.values(CHIP_IDS).forEach(id => document.getElementById(id)?.classList.remove("active"));
                document.getElementById(CHIP_IDS[emo] || "chip-neutral")?.classList.add("active");

                // Accumulate counts
                newEvents.forEach(e => {
                    const k = e.emotion || "neutral";
                    if (k in EMOTION_COUNTS) EMOTION_COUNTS[k]++;
                });
                renderEmotionTracker();
            } catch { /* backend not ready yet */ }
        }

        function stopEmotionPoll() {
            clearInterval(emotionHandle);
        }

        function renderEmotionTracker() {
            const total = Object.values(EMOTION_COUNTS).reduce((a, b) => a + b, 0) || 1;
            document.getElementById("emotion-tracker").innerHTML = Object.entries(EMOTION_COUNTS)
                .sort((a, b) => b[1] - a[1])
                .map(([emo, count]) => {
                    const pct = Math.round((count / total) * 100);
                    const color = EMOTION_COLORS[emo] || "var(--text-muted)";
                    return `<div style="margin-bottom:10px">
        <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px">
          <span style="color:var(--text-secondary);text-transform:capitalize">${emo}</span>
          <span style="color:${color};font-weight:700">${pct}%</span>
        </div>
        <div class="sentiment-bar">
          <div class="sentiment-bar__fill" style="width:${pct}%;background:${color}"></div>
        </div>
      </div>`;
                }).join("");
        }

        // â”€â”€ Real Transcript â€” polls ElevenLabs events from Flask â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let transcriptHandle = null;
        let lastTranscriptEventId = 0;
        const seenTranscriptIds = new Set();

        function startTranscriptPoll() {
            const wrap = document.getElementById("transcript-wrap");
            wrap.innerHTML = `<div style="color:var(--text-muted);font-size:13px;text-align:center;padding:30px 0">
                <div style="margin-bottom:8px">Recording audio...</div>
                <div style="font-size:11px;opacity:.6">Transcript will appear as ElevenLabs processes the session</div>
            </div>`;
            transcriptHandle = setInterval(pollTranscript, 4000);
        }

        async function pollTranscript() {
            if (!sessionId) return;
            try {
                const data = await window.api.getSession(sessionId, true);
                const txEvents = (data.events || []).filter(e => e.source === "elevenlabs" && e.text);
                const newEvents = txEvents.filter(e => !seenTranscriptIds.has(e.id));
                if (!newEvents.length) return;

                const wrap = document.getElementById("transcript-wrap");
                // Clear placeholder on first real event
                if (seenTranscriptIds.size === 0) wrap.innerHTML = "";

                newEvents.forEach(e => {
                    seenTranscriptIds.add(e.id);
                    const isSeller = (e.speaker || "").toLowerCase() === "rep" || (e.speaker || "").toLowerCase() === "seller";

                    let speakerLabel = (e.speaker || 'unknown').toUpperCase();
                    if (!isSeller && e.speaker === 'client') {
                        const clientId = document.getElementById("sel-client").value;
                        if (clientsMap[clientId]) speakerLabel = clientsMap[clientId].toUpperCase();
                    }

                    const el = document.createElement("div");
                    el.className = "transcript-line";
                    el.innerHTML = `<div class="transcript-line__speaker" style="color:${isSeller ? 'var(--red)' : '#60A5FA'}">${speakerLabel}</div>
                        <div class="transcript-line__text">${e.text}</div>`;
                    wrap.appendChild(el);
                });
                wrap.scrollTop = wrap.scrollHeight;
            } catch { /* backend not ready yet */ }
        }

        function stopTranscriptPoll() { clearInterval(transcriptHandle); }

        // â”€â”€ Main Record Button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        document.getElementById("rec-btn").addEventListener("click", async () => {
            if (!recording) {
                // â”€â”€ START â”€â”€
                const clientId = document.getElementById("sel-client").value;
                if (!clientId) { toast("Please select a client first", "error"); return; }

                const title = document.getElementById("sel-title").value.trim() || "Meeting";

                try {
                    const sess = await api.createSession({ client_id: parseInt(clientId), title });
                    sessionId = sess.id;
                    // Trigger backend transcription script
                    api.startRecording({ session_id: sessionId, record_seconds: 900 }).catch(console.error);
                } catch {
                    toast("Failed to create session â€” backend running?", "error");
                    return;
                }

                recording = true;
                document.getElementById("setup-row").style.display = "none";
                document.getElementById("rec-ring").classList.add("active");
                document.getElementById("rec-badge").style.display = "flex";
                document.getElementById("rec-btn").className = "btn btn-danger btn-lg";
                document.getElementById("rec-btn-text").textContent = "End Session";
                document.getElementById("rec-status-text").textContent = "Recordingâ€¦";
                document.getElementById("timer").style.color = "var(--red)";
                document.getElementById("session-label").textContent = `Session #${sessionId} Â· ${title} `;

                await startCamera();
                startTimer();
                startEmotionPoll();
                startTranscriptPoll();
                toast("Session started!", "success");

            } else {
                // â”€â”€ STOP â”€â”€
                recording = false;
                stopTimer();
                stopCamera();
                stopEmotionPoll();
                stopTranscriptPoll();

                document.getElementById("rec-ring").classList.remove("active");
                document.getElementById("rec-badge").style.display = "none";
                document.getElementById("rec-btn").className = "btn btn-primary btn-lg";
                document.getElementById("rec-btn-text").textContent = "Start Recording";
                document.getElementById("rec-status-text").textContent = "Session ended";
                document.getElementById("emotion-chips").style.display = "none";

                // Compute sentiment: blend MorphCast valence avg with legacy emotion counts
                const total = Object.values(EMOTION_COUNTS).reduce((a, b) => a + b, 0) || 1;
                const legacyScore = ((EMOTION_COUNTS.happy + EMOTION_COUNTS.engaged) / total) * 2 - 1;
                const mcValenceAvg = mcBuf.valence.length ? avgArr(mcBuf.valence) : null;
                // If MorphCast ran, use its valence (0-100 â†’ -1..1); otherwise fall back to legacy
                const posScore = mcValenceAvg !== null
                    ? parseFloat(((mcValenceAvg - 50) / 50).toFixed(2))
                    : parseFloat(legacyScore.toFixed(2));
                const engagement = Math.round(((EMOTION_COUNTS.happy + EMOTION_COUNTS.engaged + EMOTION_COUNTS.neutral * 0.5) / total) * 100);

                try {
                    const notes = document.getElementById("quick-notes").value || "Session completed.";
                    await api.endSession(sessionId, {
                        summary: notes,
                        overall_sentiment: parseFloat(posScore.toFixed(2)),
                        engagement_score: engagement,
                    });

                    document.getElementById("rec-status-text").textContent = "Generating AI Summaryâ€¦";
                    try {
                        if (window.utils) toast("Generating AI insights...", "info");
                        await api.generateSummary(sessionId);
                    } catch (e) {
                        console.warn("AI generation failed or not configured:", e);
                    }

                    toast("Session saved!", "success");
                    setTimeout(() => { location.href = `session.html?id=${sessionId}`; }, 800);
                } catch {
                    toast("Failed to save session data", "error");
                }
            }
        });
    </script>

    <script src="js/tutorial.js"></script>
</body>

</html>