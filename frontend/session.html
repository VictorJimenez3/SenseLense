<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SenseLense ‚Äî Session Detail</title>
    <meta name="description" content="Review session insights, emotion timeline, and full transcript." />
    <link rel="stylesheet" href="css/styles.css" />
    <script>
        /* Apply saved theme + accent color immediately */
        (function () {
            var t = localStorage.getItem('sl-theme');
            if (t === 'light') document.documentElement.setAttribute('data-theme', 'light');
            var accent = localStorage.getItem('sl-accent');
            if (accent) {
                var r = parseInt(accent.slice(1, 3), 16), g = parseInt(accent.slice(3, 5), 16), b = parseInt(accent.slice(5, 7), 16);
                var root = document.documentElement;
                root.style.setProperty('--red', accent);
                root.style.setProperty('--red-light', 'rgb(' + Math.min(255, r + 30) + ',' + Math.min(255, g + 30) + ',' + Math.min(255, b + 30) + ')');
                root.style.setProperty('--red-dark', 'rgb(' + Math.floor(r * .72) + ',' + Math.floor(g * .72) + ',' + Math.floor(b * .72) + ')');
                root.style.setProperty('--red-glow', 'rgba(' + r + ',' + g + ',' + b + ',.25)');
                root.style.setProperty('--border-red', 'rgba(' + r + ',' + g + ',' + b + ',.4)');
            }
        })();
    </script>
    <script src="js/auth.js"></script>
    <script src="js/api.js"></script>
    <script src="js/utils.js"></script>
</head>

<body>
    <div class="app-shell">

        <aside class="sidebar">
            <div class="sidebar__logo">
                <svg id="adp-logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 120 60"
                    style="height:36px;width:auto;color:var(--red);transition:color .2s ease">
                    <path
                        d="M81.952 21.15H78.08v3.87h3.873a1.66 1.66 0 0 1 1.659 1.663c0 .92-.74 1.66-1.66 1.66H78.08v3.872h3.873c3.056 0 5.532-2.478 5.532-5.532s-2.476-5.532-5.532-5.532zM59.88 41.624c4.636 0 8.632-2.715 10.5-6.645h4.937v6.645h2.764V34.98h3.873a8.3 8.3 0 0 0 8.301-8.297 8.3 8.3 0 0 0-8.301-8.299h-6.637v9.96h-3.94a11.62 11.62 0 0 0-11.497-9.959H46.26L32.7 41.624h3.232l3.872-6.645h13.923v6.645zm34.247-14.942c0 6.72-5.45 12.17-12.174 12.17V45.5h-10.5v-5.2c-2.843 3.2-6.966 5.2-11.563 5.2H49.865v-6.638h-7.827L38.166 45.5H25.873l18.07-30.98H59.88c4.598 0 8.72 2.006 11.564 5.184V14.5h10.5a12.18 12.18 0 0 1 12.174 12.172zM49.865 21.15v7.2h-6.178l-2.256 3.872h12.307V21.15zM68.734 30c0 4.9-3.966 8.85-8.854 8.85h-3.376v-3.87h3.376A4.98 4.98 0 0 0 64.862 30c0-2.747-2.23-4.98-4.982-4.98h-3.376v-3.87h3.376c4.888 0 8.854 3.962 8.854 8.85"
                        fill="currentColor" />
                </svg>
                <div class="sidebar__tagline">SenseLense</div>
            </div>
            <nav class="sidebar__nav">
                <div class="nav-section-label">Main</div>
                <a class="nav-item" href="index.html">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="7" height="7" />
                        <rect x="14" y="3" width="7" height="7" />
                        <rect x="14" y="14" width="7" height="7" />
                        <rect x="3" y="14" width="7" height="7" />
                    </svg>
                    Dashboard
                </a>
                <a class="nav-item" href="clients.html">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                        <circle cx="9" cy="7" r="4" />
                    </svg>
                    Clients
                </a>
                <a class="nav-item active" href="sessions.html">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10" />
                        <polyline points="12 6 12 12 16 14" />
                    </svg>
                    Sessions
                </a>
                <div class="nav-section-label">Actions</div>
                <a class="nav-item" href="record.html">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10" />
                        <circle cx="12" cy="12" r="3" fill="currentColor" />
                    </svg>
                    New Session
                </a>


                <a class="nav-item" href="#" id="nav-tutorial" onclick="event.preventDefault();SLTutorial.open()">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" />
                        <path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 0 3-3h7z" />
                    </svg>
                    Tutorial
                </a>

                <div class="nav-section-label">System</div>
                <a class="nav-item" href="settings.html" id="nav-settings">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="3" />
                        <path
                            d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z" />
                    </svg>
                    Settings
                </a>
            </nav>
            <div class="sidebar__footer">
                <button class="theme-toggle" id="theme-btn" onclick="toggleTheme()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5" />
                        <line x1="12" y1="1" x2="12" y2="3" />
                        <line x1="12" y1="21" x2="12" y2="23" />
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" />
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" />
                        <line x1="1" y1="12" x2="3" y2="12" />
                        <line x1="21" y1="12" x2="23" y2="12" />
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" />
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" />
                    </svg>
                    <span id="theme-label">Light Mode</span>
                    <div class="toggle-track">
                        <div class="toggle-thumb"></div>
                    </div>
                </button>
                <div class="status-badge" style="margin-top:10px">
                    <div class="status-dot online"></div>
                    <span>Backend</span>
                </div>
            </div>
        </aside>

        <div class="main">
            <header class="topbar">
                <div style="display:flex;align-items:center;gap:12px">
                    <a href="sessions.html" class="btn btn-ghost btn-icon">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="15 18 9 12 15 6" />
                        </svg>
                    </a>
                    <div>
                        <div class="topbar__title" id="sess-title">Session</div>
                        <div class="topbar__sub" id="sess-meta"></div>
                    </div>
                </div>
            </header>

            <main class="page-content">

                <!-- Metrics Row -->
                <div class="stats-grid" style="margin-bottom:24px">
                    <div class="stat-card">
                        <div class="stat-card__icon">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12" />
                            </svg>
                        </div>
                        <div class="stat-card__value" id="m-sentiment" style="font-size:20px">‚Äî</div>
                        <div class="stat-card__label">Sentiment</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card__icon">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                            </svg>
                        </div>
                        <div class="stat-card__value" id="m-engagement">‚Äî</div>
                        <div class="stat-card__label">Engagement</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card__icon">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
                            </svg>
                        </div>
                        <div class="stat-card__value" id="m-transcript">‚Äî</div>
                        <div class="stat-card__label">Transcript Chunks</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-card__icon">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10" />
                                <circle cx="12" cy="12" r="3" fill="currentColor" stroke="none" />
                            </svg>
                        </div>
                        <div class="stat-card__value" id="m-presage">‚Äî</div>
                        <div class="stat-card__label">Presage Samples</div>
                    </div>
                </div>

                <div class="grid-2" style="gap:24px;align-items:start">

                    <!-- LEFT: Summary + Insights + Timeline -->
                    <div style="display:flex;flex-direction:column;gap:20px">

                        <!-- AI Summary -->
                        <div class="card">
                            <div class="card__header">
                                <div>
                                    <div class="card__title">AI Summary</div>
                                    <div class="card__sub">Post-session analysis</div>
                                </div>
                                <span class="badge blue">Insights</span>
                            </div>
                            <p id="sess-summary" style="font-size:13px;color:var(--text-secondary);line-height:1.6">
                                Loading‚Ä¶</p>
                        </div>

                        <!-- Key Insights -->
                        <div class="card">
                            <div class="card__title" style="margin-bottom:14px">Actionable Insights</div>
                            <div id="insights-list" style="display:flex;flex-direction:column;gap:10px">
                                <div style="color:var(--text-muted);font-size:12px">Computed from session data‚Ä¶</div>
                            </div>
                        </div>

                        <!-- Emotion breakdown -->
                        <div class="card">
                            <div class="card__title" style="margin-bottom:16px">Emotion Breakdown</div>
                            <div id="emotion-breakdown">
                                <div style="color:var(--text-muted);font-size:12px">No Presage data yet</div>
                            </div>
                        </div>

                    </div>

                    <!-- RIGHT: Sentiment bar + Timeline -->
                    <div style="display:flex;flex-direction:column;gap:20px">

                        <div class="card">
                            <div class="card__title" style="margin-bottom:12px">Overall Sentiment</div>
                            <div class="sentiment-bar" style="margin-bottom:8px">
                                <div class="sentiment-bar__fill" id="sent-bar" style="width:50%"></div>
                            </div>
                            <div
                                style="display:flex;justify-content:space-between;font-size:11px;color:var(--text-muted)">
                                <span>Negative</span><span>Neutral</span><span>Positive</span>
                            </div>
                        </div>

                        <!-- Timeline -->
                        <div class="card">
                            <div class="card__title" style="margin-bottom:16px">Event Timeline</div>
                            <div id="timeline-wrap" class="timeline">
                                <div style="color:var(--text-muted);font-size:12px;padding:16px 0">No events recorded
                                </div>
                            </div>
                        </div>

                    </div>
                </div>

            </main>
        </div>
    </div>

    <div id="toast-container"></div>

    <script>
        function toggleTheme() { var t = localStorage.getItem('sl-theme') || 'dark'; var n = t === 'dark' ? 'light' : 'dark'; localStorage.setItem('sl-theme', n); document.documentElement.setAttribute('data-theme', n === 'light' ? 'light' : ''); var l = document.getElementById('theme-label'); if (l) l.textContent = n === 'light' ? 'Dark Mode' : 'Light Mode'; }
    </script>
    <script>

        const api = window.api;
        const { toast, fmtDate, sentimentLabel, fmtDuration } = window.utils;

        const sessionId = new URLSearchParams(location.search).get("id");
        if (!sessionId) { location.href = "sessions.html"; }

        (async () => {
            try {
                const [session, insights] = await Promise.all([
                    api.getSession(sessionId, true),
                    api.getInsights(sessionId),
                ]);

                document.title = `SenseLense ‚Äî ${session.title}`;
                document.getElementById("sess-title").textContent = session.title;
                document.getElementById("sess-meta").textContent =
                    `${fmtDate(session.started_at)} ¬∑ Session #${session.id}`;

                // Summary
                const rawSummary = session.summary || "No summary available. End the session to generate one.";
                document.getElementById("sess-summary").innerHTML = rawSummary
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\n\n/g, '<br><br>')
                    .replace(/\n- /g, '<br>‚Ä¢ ');

                // Metrics
                const { label, cls } = sentimentLabel(session.overall_sentiment);
                const sentEl = document.getElementById("m-sentiment");
                sentEl.textContent = label;
                sentEl.className = `stat-card__value ${cls === "positive" ? "" : cls === "negative" ? "" : ""}`;
                sentEl.style.color = cls === "positive" ? "var(--positive)" : cls === "negative" ? "var(--negative)" : "";
                document.getElementById("m-engagement").textContent = session.engagement_score ? Math.round(session.engagement_score) + "%" : "‚Äî";
                document.getElementById("m-transcript").textContent = insights.transcript_chunks;
                document.getElementById("m-presage").textContent = insights.presage_samples;

                // Sentiment bar (map -1‚Üí1 to 0‚Üí100%)
                const pct = Math.round(((session.overall_sentiment + 1) / 2) * 100);
                document.getElementById("sent-bar").style.width = pct + "%";

                // Emotion breakdown
                const breakdown = insights.emotion_breakdown || {};
                const emoWrap = document.getElementById("emotion-breakdown");
                const emoEntries = Object.entries(breakdown);
                const total = emoEntries.reduce((a, [, v]) => a + v, 0) || 1;
                const colors = { happy: "var(--positive)", neutral: "var(--text-muted)", confused: "var(--neutral)", engaged: "#60A5FA", negative: "var(--negative)" };
                if (emoEntries.length) {
                    emoWrap.innerHTML = emoEntries.sort((a, b) => b[1] - a[1]).map(([emo, count]) => {
                        const p = Math.round((count / total) * 100);
                        return `<div style="margin-bottom:10px">
          <div style="display:flex;justify-content:space-between;font-size:12px;margin-bottom:4px">
            <span style="color:var(--text-secondary);text-transform:capitalize">${emo}</span>
            <span style="font-weight:700;color:${colors[emo] || "var(--text-secondary)"}">${p}%</span>
          </div>
          <div class="sentiment-bar">
            <div class="sentiment-bar__fill" style="width:${p}%;background:${colors[emo] || "var(--text-muted)"}"></div>
          </div>
        </div>`;
                    }).join("");
                }

                // Actionable Insights
                const list = document.getElementById("insights-list");
                const tips = generateInsights(session, insights);
                list.innerHTML = tips.map(t => `
      <div class="insight-card">
        <div class="insight-card__icon" style="background:${t.bg}">${t.icon}</div>
        <div class="insight-card__text">${t.text}</div>
      </div>`).join("");

                // Timeline
                const tl = document.getElementById("timeline-wrap");
                const evs = session.events || [];
                if (evs.length) {
                    tl.innerHTML = evs.map(e => {
                        const mins = Math.floor(e.timestamp_ms / 60000);
                        const secs = Math.floor((e.timestamp_ms % 60000) / 1000);
                        const label = `${String(mins).padStart(2, "0")}:${String(secs).padStart(2, "0")}`;

                        const isPresage = e.source === "presage";
                        const cls = isPresage ? "presage" : "transcript";
                        const src = isPresage ? "Presage" : (e.source === "elevenlabs" ? "ElevenLabs" : "Wispr");

                        const isSeller = (e.speaker || "").toLowerCase() === "seller" || (e.speaker || "").toLowerCase() === "rep";
                        const speakerColor = isSeller ? "var(--red)" : "#60A5FA";
                        let speakerLabel = (e.speaker || "unknown").toUpperCase();
                        if (!isSeller && e.speaker === "client" && session.client_name) {
                            speakerLabel = session.client_name.toUpperCase();
                        }

                        const body = isPresage
                            ? `<div>${e.emotion || "?"} ${e.valence != null ? `(${e.valence > 0 ? "+" : ""}${e.valence.toFixed(2)})` : ""}</div>`
                            : `<div>${e.speaker ? `<span class="timeline-event__speaker" style="color:${speakerColor};font-weight:700">${speakerLabel} ¬∑ </span>` : ""}${e.text || ""}</div>`;

                        return `<div class="timeline-event ${cls}">
          <div class="timeline-event__time">${label}</div>
          <div class="timeline-event__content">
            <div class="timeline-event__source">${src}</div>
            <div class="timeline-event__text">${body}</div>
          </div>
        </div>`;
                    }).join("");
                }

            } catch (e) {
                console.error(e);
                toast("Failed to load session", "error");
            }
        })();

        function generateInsights(session, insights) {
            const tips = [];
            const { label } = sentimentLabel(session.overall_sentiment);

            if (session.overall_sentiment > 0.2) {
                tips.push({ icon: "‚úÖ", bg: "rgba(34,197,94,0.12)", text: `<strong>Positive overall sentiment</strong> ‚Äî the client showed mostly positive reactions. Good momentum to build on in the follow-up.` });
            } else if (session.overall_sentiment < -0.2) {
                tips.push({ icon: "‚ö†Ô∏è", bg: "rgba(239,68,68,0.12)", text: `<strong>Negative sentiment detected.</strong> Review the moments where the client seemed displeased and address those objections in your next touchpoint.` });
            } else {
                tips.push({ icon: "‚ÑπÔ∏è", bg: "rgba(234,179,8,0.12)", text: `<strong>Neutral sentiment</strong> ‚Äî the client was composed but non-committal. Consider adding a stronger call-to-action in the follow-up.` });
            }

            if (session.engagement_score > 70) {
                tips.push({ icon: "üî•", bg: "rgba(59,130,246,0.12)", text: `<strong>High engagement (${Math.round(session.engagement_score)}%)</strong> ‚Äî the customer was actively engaged. Strike while the iron is hot.` });
            } else if (session.engagement_score < 40) {
                tips.push({ icon: "üò¥", bg: "rgba(234,179,8,0.1)", text: `<strong>Low engagement (${Math.round(session.engagement_score)}%)</strong> ‚Äî consider a shorter, more focused pitch next time.` });
            }

            if (insights.presage_samples === 0) {
                tips.push({ icon: "üì∑", bg: "rgba(100,100,100,0.1)", text: `<strong>No Presage data</strong> ‚Äî connect the camera feed to start capturing facial emotion data.` });
            }

            if (insights.transcript_chunks === 0) {
                tips.push({ icon: "üéôÔ∏è", bg: "rgba(100,100,100,0.1)", text: `<strong>No transcript data</strong> ‚Äî connect the Wispr / ElevenLabs flow to capture spoken dialogue.` });
            }

            if (!tips.length) {
                tips.push({ icon: "üìã", bg: "rgba(100,100,100,0.1)", text: "Session data is still being processed." });
            }

            return tips;
        }
    </script>

    <script src="js/tutorial.js"></script>
</body>

</html>